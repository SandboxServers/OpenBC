# RFC: OpenBC Standalone Server Architecture

**Status**: Draft
**Author**: Cadacious / Claude
**Date**: 2026-02-15

## 1. Goals

OpenBC is a fully open-source, mod-extensible multiplayer server for Star Trek: Bridge Commander. It replaces all original STBC content -- binary, scripts, and data files -- with clean-room implementations while maintaining wire-protocol compatibility with stock BC 1.1 clients.

**Design principles:**
- **Protocol-first**: The client is a protocol endpoint. Compatibility means speaking the wire protocol correctly.
- **Mod-native**: Every layer exposes extension points. Mods are first-class, not bolted on.
- **Data-driven**: Ship stats, weapon configs, maps, and game rules live in data files, not code.
- **Zero original content**: The server ships with no copyrighted STBC material. Game data is provided via hash manifests and data registries that reference the client's local files.

## 2. Architecture Overview

```
┌──────────────────────────────────────────────────────────┐
│                    OpenBC Server                         │
│                                                          │
│  ┌─────────┐  ┌──────────┐  ┌─────────┐  ┌───────────┐  │
│  │ Network  │  │ Checksum │  │  Game   │  │   Mod     │  │
│  │  Layer   │──│ Validator│──│  State  │──│  Loader   │  │
│  │ (UDP)    │  │(Manifest)│  │ Engine  │  │           │  │
│  └────┬─────┘  └──────────┘  └────┬────┘  └─────┬─────┘  │
│       │                          │              │         │
│  ┌────┴─────┐  ┌──────────┐  ┌───┴────┐  ┌─────┴─────┐  │
│  │ Protocol │  │  Opcode  │  │Physics │  │   Data    │  │
│  │  Codec   │  │ Handlers │  │  Sim   │  │ Registry  │  │
│  │(wire fmt)│  │(28 actv) │  │        │  │(ships,etc)│  │
│  └──────────┘  └──────────┘  └────────┘  └───────────┘  │
└──────────────────────────────────────────────────────────┘
        ▲                                        ▲
        │ UDP packets                            │ JSON
        ▼                                        │
  ┌───────────┐                          ┌───────────────┐
  │ Stock BC  │                          │  Mod Packs    │
  │  Client   │                          │ (data + hash  │
  │  (1.1)    │                          │  manifests)   │
  └───────────┘                          └───────────────┘
```

## 3. Network Layer

> Transport, protocol codec, and GameSpy details moved to dedicated docs. See [../protocol/transport-layer.md](../protocol/transport-layer.md), [../protocol/transport-cipher.md](../protocol/transport-cipher.md), and [../protocol/gamespy-protocol.md](../protocol/gamespy-protocol.md).

## 4. Checksum Validation Layer

> Moved to [../wire-formats/checksum-handshake-protocol.md](../wire-formats/checksum-handshake-protocol.md).

## 5. Game State Engine

> Opcode table and game event formats moved to [../protocol/protocol-reference.md](../protocol/protocol-reference.md). Ship state model and subsystem details moved to [../game-systems/ship-subsystems.md](../game-systems/ship-subsystems.md) and [../wire-formats/stateupdate-wire-format.md](../wire-formats/stateupdate-wire-format.md).

## 6. Physics Simulation

> Moved to [../game-systems/collision-detection-system.md](../game-systems/collision-detection-system.md) and [../game-systems/combat-system.md](../game-systems/combat-system.md).

## 7. Data Registry

> Moved to [../game-systems/data-registry.md](../game-systems/data-registry.md).

## 8. Mod System

### 8.1 Mod Pack Structure

```
my-mod/
  manifest.json          # Hash manifest (generated by tool)
  ships.toml             # Additional/modified ship definitions
  maps.toml              # Additional/modified maps
  rules.toml             # Custom game rules
  README.md              # Mod description
```

### 8.2 Mod Loading

Server config specifies active mods:

```toml
# server.toml

[server]
name = "OpenBC Deathmatch"
port = 22101
max_players = 8

[mods]
active = ["vanilla-1.1", "custom-ships-v3"]

# Load order: later mods override earlier ones
# Ship/map/rules from custom-ships-v3 override vanilla-1.1
```

### 8.3 Client Validation

When a mod changes checksummed files (ships/*.pyc), the mod's manifest must include the new hashes. The server validates that connecting clients have the correct mod installed:

1. Server loads mod manifest (contains expected hashes for modified files)
2. Client connects -> server sends checksum requests
3. Client responds with hashes of its local files
4. Server compares against mod manifest
5. Match -> client has the mod installed, allow connection
6. Mismatch -> reject with clear error ("Requires Custom Ships v3")

Mods that only affect `scripts/Custom/` (the checksum-exempt directory) need no manifest -- any client can connect.

## 9. Migration Path

### From Current Proxy to Standalone OpenBC

The transition is incremental. Each phase produces a working server:

**Phase A: Hash Manifest Tool** -- Extract lookup tables, StringHash + FileHash, CLI manifest generator/verifier

**Phase B: Protocol Library** -- AlbyRules cipher, TGBufferStream codec, compressed type encoders

**Phase C: Lobby Server** -- UDP socket, peer management, checksum validation, settings, chat, GameSpy

**Phase D: Relay Server** -- StateUpdate relay, weapon fire relay, object creation/destruction, data registry

**Phase E: Simulation Server** -- Server-authoritative physics, damage system, subsystem tracking, game rules

### Coexistence

During migration, both servers can operate:
- **Proxy server** (current): runs game executable, full fidelity, proven stable
- **OpenBC server**: standalone, mod-extensible, growing feature set

Clients can connect to either -- they speak the same protocol.

## 10. Technology Choices

| Component | Recommendation | Rationale |
|-----------|---------------|-----------|
| Language | **C** (core) + **Python 3** (tooling) | Performance-critical paths in C; Python for build tools |
| Build | **Make** | Already works, cross-compiles from WSL2 |
| Config format | **JSON** | Machine-generated data files, tool-friendly |
| Manifest format | **JSON** | Machine-generated, easy to validate |
| Physics | **Custom** (Euler integration + mesh-accurate collision) | Matches original BC fidelity |
| Networking | **Raw UDP** (Winsock/BSD) | Must match BC wire format |

## 11. Resolved Design Decisions

1. **Version string**: Identified as `"60"`. Hash: `StringHash("60") = 0x7E0CE243`. Used as version gate in checksum exchange. **RESOLVED** -- implemented in manifest system.

2. **StateUpdate direction split**: Server sends subsystem health (flag 0x20), client sends weapon status (flag 0x80). Verified as mutually exclusive by direction. **RESOLVED** -- documented fact.

3. **Mesh-accurate collision**: **YES.** OpenBC implements mesh-accurate collisions by extracting convex hull data from NIF model geometry. Bounding spheres for broad-phase, NIF-derived collision meshes for narrow-phase.

4. **Internet play**: **YES.** OpenBC implements the GameSpy master server protocol for internet game discovery, compatible with 333networks and other community-maintained replacements.

## 12. Related Documents

| Document | Description |
|----------|-------------|
| [../protocol/protocol-reference.md](../protocol/protocol-reference.md) | Complete wire format (opcodes, packet formats, compressed types) |
| [../network-flows/join-flow.md](../network-flows/join-flow.md) | Full join flow (connect -> checksum -> settings -> ship select -> play) |
| [../protocol/tgmessage-routing.md](../protocol/tgmessage-routing.md) | Protocol architecture, dispatcher routing |
| [../game-systems/combat-system.md](../game-systems/combat-system.md) | Damage pipeline (collision, weapon, explosion paths) |
